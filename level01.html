<html>
  <head>
    <title>Veggie Chase</title>
    <meta http-equiv="Content-Type" content="text/html" charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="stylesheet" type="text/css" href="_css/author.css">
    <link rel="stylesheet" type="text/css" href="_css/responsive.css">
 
    <link href="_css/player.css" rel="stylesheet" />
    <script src="libs/keycodes.js"></script>
    <script src="libs/modernizr.js"></script>
  </head>

   <body onload="init();">
     <!-- SCRIPT IMPORTS -->
      <script src="_js/Animation.js"></script>
      <script src="_js/ghost.js"></script>
      <script src="_js/KeyButton.js"></script>
      <script src="_js/Level.js"></script>
      <script src="_js/pip.js"></script>
      <script src="_js/Player.js"></script>
    <head>
  	   <title>Veggie Chase</title>
  	   <meta http-equiv="Content-Type" content="text/html" charset="utf-8"/>
  	   <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  	   <link rel="stylesheet" type="text/css" href="_css/author.css">
  	   <link rel="stylesheet" type="text/css" href="_css/responsive.css">

  	   <!-- <canvas id="mycanvas" width="640" height=""></canvas> -->
  	    <img id="image-lenna" src="_images/level02.png" style="display:none" />
  		<canvas id="image-canvas"></canvas>
       <script> 

       	// Window scaling sizes 
       	 canvas = document.getElementById('mycanvas');
 
	    // Set canvas dimensions
	    canvas.width = window.innerWidth;
	    canvas.height = window.innerHeight;

	     var canvas;
	      var canvasWidth;
	      var ctx;
	 
	      function init() {
	        canvas = document.getElementById('canvas');
	        if (canvas.getContext) {
	          ctx = canvas.getContext("2d");
	 
	          window.addEventListener('resize', resizeCanvas, false);
	          window.addEventListener('orientationchange', resizeCanvas, false);
	          resizeCanvas();
	        }
	      }
	 
	      function resizeCanvas() {
	        canvas.width = window.innerWidth;
	        canvas.height = window.innerHeight;
	      }

	        var canvas = document.getElementById('mycanvas');
  			var ctx = canvas.getContext('2d');

  		// 	 // Copy canvas as image data
		  // var imgData = ctx.getImageData(0,0, canvas.width, canvas.height);
		 
		  // // Resize original canvas
		  // canvas.width = window.innerWidth;
		  // canvas.height = window.innerHeight;
		 
		  // // Copy back to resized canvas
		  // ctx.putImageData(imgData, 0, 0);

		  // // Set up temporary canvas
		  // var tmpCanvas = document.createElement('canvas');
		  // tempCanvas.width = canvas.width;
		  // tempCanvas.height = canvas.height;
		  // tmpCtx = tempCanvas.getContext('2d');
		 
		  // // Copy to temporary canvas
		  // tempCanvas.drawImage(canvas, 0, 0);
		 
		  // // Resize original canvas
		  // canvas.width = window.innerWidth;
		  // canvas.height = window.innerHeight;
		 
		  // // Copy back to resized canvas
		  // ctx = canvas.getContext('2d');
		  // ctx.drawImage(tempCanvas, 0, 0, tempCanvas.width, tempCanvas.height, 0, 0, canvas.width, canvas.height);


		   // drawImage(image, x, y);
		   // drawImage(image, x, y, width, height);


			var canvas = document.getElementById('image-canvas');
		  	ctx = canvas.getContext('2d');
		  	var img = document.getElementById('image-lenna');
		 
		  // Only draw image after it's loaded
		  	img.onload = function() {
		    var x = canvas.width/2 - img.width/2;
		    var y = canvas.height/2 - img.height/2;
		    ctx.drawImage(img, x, y);
		  }



        // game vars
        var gameInterval,
          score = 0,
          isPlaying, isKeyDown,
           lastX, lastY,
           isSameColumn, isSameRow,
         
         // screen/game size vars
          SCREEN_WIDTH = window.innerWidth,
          SCREEN_HEIGHT = window.innerHeight,

          // SCREEN_WIDTH = 640, //595
          // SCREEN_HEIGHT = 1136, //625
          CELL_SIZE = 32,
          // GRID_WIDTH = window.innerWidth / CELL_SIZE,
          // GRID_HEIGHT = window.innerHeight / CELL_SIZE,

          GRID_WIDTH = SCREEN_WIDTH / CELL_SIZE,
          GRID_HEIGHT = SCREEN_HEIGHT / CELL_SIZE,
        
        // timestep
          t = 0,
          dt = 10,
          currentTime = (new Date).getTime(),
          accumulator = 0,
        
        // display surface vars
          canvas = document.createElement("canvas"),
          context = canvas.getContext("2d"),
        
        // buttons
          leftButton, rightButton, upButton, downButton,
        
        // input vars
          leftDown, rightDown, upDown, downDown, isTouch,
        // preload image resources
          assetImages = {};
        
        var playerImage = assetImages["player"] = new Image();
        assetImages["player"].src = "_images/player.png";
        
        var ghostImage = assetImages["ghost"] = new Image();
        assetImages["ghost"].src = "_images/ghost.png";
        
        var levelImage = assetImages["level"] = new Image();
        assetImages["level"].src = "_images/level.png";
        
        function init()
        {
          // CANVAS SET UP
          container = document.createElement("div");
          container.id = "container";
          container.style.width = SCREEN_WIDTH + "px";
          container.style.height = SCREEN_HEIGHT + "px";
          document.body.appendChild(container);
          container.appendChild(canvas);

          // canvas.width = window.innerWidth;
          // canvas.height = window.innerHeight;

          canvas.width = SCREEN_WIDTH; 
          canvas.height = SCREEN_HEIGHT;
          
          // EVENT LISTENERS
          document.addEventListener("keydown", onKeyPress, false);
          document.addEventListener("keyup", onKeyPress, false);
          container.addEventListener("click", onClicked, false);
          
          // level
         level = new Level(levelImage, context);
         
         charcontainer = document.createElement("div");
         charcontainer.className = "charcontainer";
         charcontainer.style.width = SCREEN_WIDTH + "px";
         charcontainer.style.height = SCREEN_HEIGHT + "px";
         container.appendChild(charcontainer);
         
         // player character
         player = new Player(CELL_SIZE, CELL_SIZE, playerImage); //CELL_SIZE, CELL_SIZE, //
         charcontainer.appendChild(player.domElement);
         
         // ghost
         ghost = new Ghost(CELL_SIZE * 11, CELL_SIZE * 5, ghostImage); 
         charcontainer.appendChild(ghost.domElement);
         
          infobg = document.createElement('div');
          infobg.id = "infobg";
          infobg.className = "info";
          infobg.style.width = SCREEN_WIDTH + 'px';
          infobg.style.height = SCREEN_HEIGHT + 'px';
          container.appendChild(infobg);
          info = document.createElement('div');
          info.id = "info";
          info.className = "info";
          info.style.width = '100%';
          container.appendChild(info);
          
          scoreContainer = document.createElement('div');
          scoreContainer.id = "score";
          scoreContainer.style.width = SCREEN_WIDTH + 'px';
          document.body.appendChild(scoreContainer);
          
          player.init();
          ghost.init();
          
          if(Modernizr.touch)
          {
            isTouch = true;
            makeControls();
          }
          
          showInfo("<p>" + ((isTouch) ? "TOUCH" : "CLICK") + " TO START</p>");
        }
        
        function run()
        {
          var newTime = (new Date).getTime();
          var deltaTime = (newTime - currentTime);
          currentTime = newTime;
          if(deltaTime > 25)
          {
            deltaTime = 25;
          }
          accumulator += deltaTime;
          
          while(accumulator >= dt)
          {
            accumulator -= dt;
            update();
          }
          render();
        }
        
        function update()
        {
          player.update();
          ghost.update();
          
          if(player.xp % CELL_SIZE == 0 && player.yp % CELL_SIZE == 0)
          {
            var cx = player.row = player.xp / CELL_SIZE;
            var cy = player.column = player.yp / CELL_SIZE;
            
            if(upDown && player.dirY > -1 && level.cellData[cx][cy - 1] != 0) player.moveUp();
            else if(downDown && player.dirY < 1 && level.cellData[cx][cy + 1] != 0) player.moveDown();
            else if(leftDown && player.dirX > -1 && level.cellData[cx - 1][cy] != 0) player.moveLeft();
            else if(rightDown && player.dirX < 1 && level.cellData[cx + 1][cy] != 0) player.moveRight();
            else if(player.dirX == 1 && level.cellData[cx + 1][cy] == 0) player.stopMovement();
            else if(player.dirX == -1 && level.cellData[cx - 1][cy] == 0) player.stopMovement();
            else if(player.dirY == 1 && level.cellData[cx][cy + 1] == 0) player.stopMovement();
            else if(player.dirY == -1 && level.cellData[cx][cy - 1] == 0) player.stopMovement();
            
            if(level.cellData[cx][cy] == 1)
            {
              level.pips[cx][cy].munch();
              level.cellData[cx][cy] = 2;
              ++score;
              document.getElementById("score").innerHTML = "SCORE: " + score;
              if(score == level.totalPips)
              {
                onGameOver(true);
              }
            }        
           isSameRow = player.row == ghost.row;
            isSameColumn = player.column == ghost.column;
          }
          else
          {
            if(upDown && player.dirY != -1 && player.dirX == 0) player.moveUp();
            else if(downDown && player.dirY != 1 && player.dirX == 0) player.moveDown();
            else if(leftDown && player.dirX != -1 && player.dirY == 0) player.moveLeft();
            else if(rightDown && player.dirX != 1 && player.dirY == 0) player.moveRight();
          }
          
          if(ghost.xp % CELL_SIZE == 0 && ghost.yp % CELL_SIZE == 0)
          {
            updateGhost();
            
            isSameRow = player.row == ghost.row;
            isSameColumn = player.column == ghost.column;
          }
          
          
          if(isSameRow || isSameColumn)
          {
            var dx = Math.abs(player.xp - ghost.xp);
            var dy = Math.abs(player.yp - ghost.yp);
            var dist = Math.sqrt(dx * dx + dy * dy);
            
            if(dist < CELL_SIZE)
            {
              onGameOver(false);
            }
          }
        }
        
        function render()
        {
          player.render();
          ghost.render();
        }
        
        function updateGhost()
        {
          var playerCellX = player.row;
          var playerCellY = player.column;
          
           var playerChangedPos = (playerCellX != lastX || playerCellY != lastY);
           lastX = playerCellX;
           lastY = playerCellY;
           
           var lastRow = ghost.row;
           var lastColumn = ghost.column;
           
           var cx = ghost.row = ghost.xp / CELL_SIZE;
           var cy = ghost.column = ghost.yp / CELL_SIZE;
           
           if(!ghost.chasing && (ghost.dirX != 0 || ghost.dirY != 0))
           {
             var nextTileFree = false;
             
            if(ghost.dirY <= -1 && level.cellData[cx][cy - 1] != 0) nextTileFree = true;
            else if(ghost.dirY >= 1 && level.cellData[cx][cy + 1] != 0) nextTileFree = true;
            else if(ghost.dirX <= -1 && level.cellData[cx - 1][cy] != 0) nextTileFree = true;
            else if(ghost.dirX >= 1 && level.cellData[cx + 1][cy] != 0) nextTileFree = true;
            
            if(nextTileFree) return;
          }
          
           var nodes = [];
           
           if(level.cellData[cx + 1][cy] != 0) nodes.push([cx + 1, cy, 1, 0]);
           if(level.cellData[cx - 1][cy] != 0) nodes.push([cx - 1, cy, -1, 0]);
           if(level.cellData[cx][cy + 1] != 0) nodes.push([cx, cy + 1, 0, 1]);
           if(level.cellData[cx][cy - 1] != 0) nodes.push([cx, cy - 1, 0, -1]);
          
          if(nodes.length == 1)
          {
            ghost.dirX = nodes[0][2];
            ghost.dirY = nodes[0][3];
          }
          else if(!ghost.chasing)
          {
            var node = nodes[Math.floor(Math.random() * nodes.length)];
            ghost.dirX = node[2];
            ghost.dirY = node[3];
          }
          else
          {
            var smallest = Infinity;
            var node;
            
            var i = nodes.length;
            while(--i > -1)
            {
              var dx = Math.abs(playerCellX - nodes[i][0]);
              var dy = Math.abs(playerCellY - nodes[i][1]);
              var dist = Math.sqrt(dx * dx + dy * dy);
              if(dist < smallest && ((nodes[i][0] != lastRow && nodes[i][1] != lastColumn) || playerChangedPos))
              {
                smallest = dist;
                node = nodes[i];
              }
            }
            
            if(node)
            {
              ghost.dirX = node[2];
              ghost.dirY = node[3];
            }
          }
        }
        
        function onGameOver(complete)
        {
          stopGame();
           
           var str;
           if(complete)
           {
             str = "<h1>YOU WIN!</h1><p>" + ((isTouch) ? "TOUCH" : "CLICK") + " TO PLAY AGAIN</p>";
           }
           else
           {
             str = "<h1>GAME OVER</h1><p>" + ((isTouch) ? "TOUCH" : "CLICK") + " TO RESTART</p>";
           }
           
           showInfo(str);
           container.addEventListener('click', onClicked, false);
           if(isTouch) container.addEventListener("touchstart", onClicked, false);
           container.style.cursor = "pointer";
         }
         
         function resetGame()
         {
           score = 0;
           level.reset();
           player.reset();
           ghost.reset();
         }
         
         function showInfo(str)
         {
           if(str)
           {
             document.getElementById("info").innerHTML = str;
             info.style.top = (SCREEN_HEIGHT - info.offsetHeight) * 0.5 + "px"; 
           }
           
           info.style.opacity = 1;
           infobg.style.opacity = 0.55;
         }
         
         function makeControls()
         { 
           document.addEventListener("touchmove", function(e){e.preventDefault();}, false);
           document.addEventListener("touchstart", function(e){e.preventDefault();}, false);

           var w = 120;
           var h = 250;
           var space = 50;
           
           buttons = document.createElement("div");
           buttons.id = "container";
           buttons.style.width = SCREEN_WIDTH + "px";
           buttons.style.height = SCREEN_HEIGHT + "px";
           document.body.appendChild(buttons);
           
           var button;
           
           button = new KeyButton((SCREEN_WIDTH * 0.5) - (w * 0.5) - w, h-180);
           leftButton = button.domElement;
           leftButton.addEventListener("touchstart", onKeyPress, false);
           leftButton.addEventListener("touchend", onKeyPress, false);
           buttons.appendChild(leftButton);
           
           button = new KeyButton((SCREEN_WIDTH * 0.5) + (w * 0.5), h-180);
           rightButton = button.domElement;
           rightButton.addEventListener("touchstart", onKeyPress, false);
           rightButton.addEventListener("touchend", onKeyPress, false);
           buttons.appendChild(rightButton);
           
           button = new KeyButton((SCREEN_WIDTH - w) * 0.5, h-240);
           upButton = button.domElement;
           upButton.addEventListener("touchstart", onKeyPress, false);
           upButton.addEventListener("touchend", onKeyPress, false);
           buttons.appendChild(upButton);
           
           button = new KeyButton((SCREEN_WIDTH - w) * 0.5, h-120);
           downButton = button.domElement;
           downButton.addEventListener("touchstart", onKeyPress, false);
           downButton.addEventListener("touchend", onKeyPress, false);
           buttons.appendChild(downButton);
           
           container.addEventListener("touchstart", onClicked, false);
         }
         
         function onClicked(e)
         {
           container.removeEventListener('click', onClicked, false);
           if(isTouch) container.removeEventListener("touchstart", onClicked, false);
           container.style.cursor = "default";
           
           startGame();
           info.style.opacity = 0;
           infobg.style.opacity = 0;
         }
         
         function onKeyPress(e)
         {
           if(!isPlaying && !isKeyDown) onClicked();
           isKeyDown = (isTouch) ? (e.type == "touchstart") : (e.type == "keydown");
           
           switch((isTouch) ? e.target : e.keyCode)
           {
             case KEY_LEFT :
             case leftButton :
               leftDown = isKeyDown;
               break;
             
             case KEY_RIGHT :
             case rightButton :
               rightDown = isKeyDown;
               break;
             
             case KEY_UP :
             case upButton :
               upDown = isKeyDown;
               break;
             
             case KEY_DOWN :
             case downButton :
               downDown = isKeyDown;
              break;
          }
        }
        
        function startGame()
        {
          if(isPlaying) return;
          isPlaying = true;
          document.getElementById("score").innerHTML = "SCORE: " + score;
          resetGame();
          gameInterval = setInterval(run, 1);
        }
         function stopGame()
         {
           isPlaying = false;
           clearInterval(gameInterval);
         }
       </script>
      
    	</body>
</html>
